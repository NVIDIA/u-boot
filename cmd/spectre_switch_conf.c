/*
 * Spectre switch intialization.
 */

#include <common.h>
#include <command.h>
#include <miiphy.h>

typedef struct _MII_reg_desc_t {
	unsigned char	port;
	unsigned char	reg;
	unsigned short	value
} MII_reg_desc_t;

/* config ports 0*/
static const MII_reg_desc_t port0_seq[] = {
{0x0, 0x4, 0x7C},
{0x0, 0x1, 0x13},
{0x0, 0x1, 0x2013},
{0x0, 0x1, 0x2013},
{0x0, 0x1, 0x2012},
{0x0, 0x1, 0x2002},
{0x0, 0x1, 0x200E},
{0x0, 0x1, 0x203E},
{0x0, 0x4, 0x7F}};

/* config ports 1-6 and 9*/
static const MII_reg_desc_t switch_seq[] = {
{0x1B, 0x1B, 0x2000},
{0x1B, 0x1A, 0x8400},
{0x1B, 0x19, 0xFF0C},
{0x1B, 0x1B, 0x400},
{0x1C, 0x18, 0x9836},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x9436},
{0x1C, 0x18, 0x9820},
{0x1C, 0x19, 0x1140},
{0x1C, 0x18, 0x9420},
{0x1C, 0x18, 0x9836},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x9436},
{0x1, 0x4, 0x7F},
{0x1, 0x16, 0x00},
{0x1, 0x16, 0x8021},
{0x1, 0x16, 0x00},
{0x1, 0x16, 0x80E1},
{0x1C, 0x18, 0x9856},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x9456},
{0x1C, 0x18, 0x9840},
{0x1C, 0x19, 0x1140},
{0x1C, 0x18, 0x9440},
{0x1C, 0x18, 0x9856},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x9456},
{0x2, 0x4, 0x7F},
{0x2, 0x16, 0x00},
{0x2, 0x16, 0x8021},
{0x2, 0x16, 0x00},
{0x2, 0x16, 0x80E1},
{0x1C, 0x18, 0x9876},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x9476},
{0x1C, 0x18, 0x9860},
{0x1C, 0x19, 0x1140},
{0x1C, 0x18, 0x9460},
{0x1C, 0x18, 0x9876},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x9476},
{0x3, 0x4, 0x7F},
{0x3, 0x16, 0x00},
{0x3, 0x16, 0x8021},
{0x3, 0x16, 0x00},
{0x3, 0x16, 0x80E1},
{0x1C, 0x18, 0x9896},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x9496},
{0x1C, 0x18, 0x9880},
{0x1C, 0x19, 0x1140},
{0x1C, 0x18, 0x9480},
{0x1C, 0x18, 0x9896},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x9496},
{0x4, 0x4, 0x7F},
{0x4, 0x16, 0x00},
{0x4, 0x16, 0x8021},
{0x4, 0x16, 0x00},
{0x4, 0x16, 0x80E1},
{0x1C, 0x18, 0x98B6},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x94B6},
{0x1C, 0x18, 0x98A0},
{0x1C, 0x19, 0x1140},
{0x1C, 0x18, 0x94A0},
{0x1C, 0x18, 0x98B6},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x94B6},
{0x5, 0x4, 0x7F},
{0x5, 0x16, 0x00},
{0x5, 0x16, 0x8021},
{0x5, 0x16, 0x00},
{0x5, 0x16, 0x80E1},
{0x1C, 0x18, 0x98D6},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x94D6},
{0x1C, 0x18, 0x98C0},
{0x1C, 0x19, 0x1140},
{0x1C, 0x18, 0x94C0},
{0x1C, 0x18, 0x98D6},
{0x1C, 0x19, 0x00},
{0x1C, 0x18, 0x94D6},
{0x6, 0x4, 0x7F},
{0x6, 0x16, 0x00},
{0x6, 0x16, 0x8021},
{0x6, 0x16, 0x00},
{0x6, 0x16, 0x80E1},
{0x9, 0x4, 0x17C},
{0x9, 0x1, 0x13},
{0x9, 0x1, 0x2013},
{0x9, 0x1, 0x2013},
{0x9, 0x1, 0x2013},
{0x9, 0x1, 0x2003},
{0x9, 0x1, 0x200F},
{0x9, 0x1, 0x203F},
{0x9, 0x4, 0x17F},
{0x1C, 0x19, 0xF002},
{0x1C, 0x18, 0x8124},
{0x1C, 0x18, 0x8D24},
{0x1C, 0x19, 0xF002},
{0x1C, 0x18, 0x8124},
{0x1C, 0x19, 0x804D},
{0x1C, 0x18, 0x8524},
{0x1C, 0x19, 0x1000},
{0x1C, 0x18, 0x8124},
{0x1C, 0x18, 0x8D24},
{0x1C, 0x19, 0x1000},
{0x1C, 0x18, 0x8124},
{0x1C, 0x19, 0xA040},
{0x1C, 0x18, 0x8524}};


/* ---------------------------------------------------------------- */
static int switch_config(cmd_tbl_t *cmdtp, int flag, int argc, char * const argv[])
{
	int	rcode = 0;
	int size;
	int index;

	if (argc > 1)
	{
		printf("Parameters are not expected\n");
		return CMD_RET_USAGE;
	}

	size = ARRAY_SIZE(switch_seq);

	/* config port 1-6, 9  - eth3 switch*/
	printf("Spectre eth3 switch config\n");
	for(index = 0; index < size; index++)
	{
		if (miiphy_write("eth3",switch_seq[index].port, switch_seq[index].reg, switch_seq[index].value) != 0) {
			printf("Error writing to the PHY addr=%02x reg=%02x, value=%04x\n",
					switch_seq[index].port, switch_seq[index].reg, switch_seq[index].value);
			rcode = 1;
		}
	}

	printf("Spectre eth2 switch config\n");

	/* config port 1-6, 9  - eth2 switch*/
	for(index = 0; index < size; index++)
	{
		if (miiphy_write("eth2", switch_seq[index].port, switch_seq[index].reg, switch_seq[index].value) != 0) {
			printf("Error writing to the PHY addr=%02x reg=%02x, value=%04x\n",
					switch_seq[index].port, switch_seq[index].reg, switch_seq[index].value);
			rcode = 1;
		}
	}

	/* config port 0 - eth2 switch*/
	size = ARRAY_SIZE(port0_seq);
	for(index = 0; index < size; index++)
	{
		if (miiphy_write("eth2", port0_seq[index].port, port0_seq[index].reg, port0_seq[index].value) != 0) {
			printf("Error writing to the PHY addr=%02x reg=%02x, value=%04x\n",
					port0_seq[index].port, port0_seq[index].reg, port0_seq[index].value);
			rcode = 1;
		}
	}
	return rcode;
}

/***************************************************/

U_BOOT_CMD(
	switch_en, 1, 1, switch_config,
	"switch confing",
	"config switch to transparent mode"
);
